<div id="ecmBody">
  <hr id="ecmReplaceBody">
  <script>
    // parsefullname wants exports
    globalThis.exports = globalThis.exports || {}

    const initEvent = new Event("ecm-init-finished");
    
    ECM.loadScripts(
	"codemirror/editor.bundle.js",
	"ecm-datetime.js",
	"ecm-interval.js",
	"ecm-datatable.js",
	"admin-pi.js",
	"entity/indexeddb.js",
	"entity/map.js",
	"entity/cache.js",
	"entity/contract.js", "contract.js",
	"entity/address.js",
	"entity/person.js",
	"entity/select-person.js",
	"entity/upsert-person.js",
	"entity/view-person.js",
	"entity/entity.js", "entity/claim.js",
	"entity/policy.js",
	"entity/user.js",
	"entity/diary.js", "bordereau.js",
	"query.js", "movement.js",
	"open-claims.js", "static-claims.js",
	"time-recorded.js", "user-time-recorded.js"
	)
    .then(r => {
	const user = User.init()
	const redir = ((go = false) => {
            if (go) {
		window.location.replace(`/ecm/login/?q=${encodeURIComponent(window.location.pathname)}`)
	    }
	    return false
	})
	console.log('init', user)
	if (user) {
	    user.promise.then(u => {
		if (u) {
		    const body = document.querySelector("#ecmBody")
		    ECM.replaceElement(body.firstElementChild, "main.html").then(_ => { document.body.dispatchEvent(initEvent) })
		} else {
		    redir(true)
		}
	    }).catch(e => redir())
	} else { redir(true) ; }
	
 
	console.log('loaded', r) })
  </script>
 </div>
